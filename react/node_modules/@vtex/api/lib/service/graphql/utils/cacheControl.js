"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const ramda_1 = require("ramda");
const maxAgeEnum_1 = require("../utils/maxAgeEnum");
const pluck = (p) => (list) => ramda_1.pluck(p, list);
const publicRegExp = ramda_1.compose((exp) => new RegExp(exp), (exp) => `.*${exp}.*`, ramda_1.replace('.', '\\.'));
const VTEX_PUBLIC_ENDPOINT = process.env.VTEX_PUBLIC_ENDPOINT || '';
const GOCOMMERCE_PUBLIC_ENDPOINT = 'mygocommerce.com';
const GOCOMMERCE_REGEXP = publicRegExp(GOCOMMERCE_PUBLIC_ENDPOINT);
const VTEX_REGEXP = publicRegExp(VTEX_PUBLIC_ENDPOINT);
const pickCacheControlHints = (response) => ramda_1.path(['extensions', 'cacheControl', 'hints'], response);
const minArray = (nums) => ramda_1.reduce(ramda_1.min, maxAgeEnum_1.maxAgeEnums.LONG, nums);
const minMaxAge = (hints) => ramda_1.compose(minArray, ramda_1.reject(ramda_1.isNil), pluck('maxAge'))(hints);
const anyPrivate = (hints) => ramda_1.compose(ramda_1.any(ramda_1.equals('PRIVATE')), pluck('scope'))(hints);
const anySegment = (hints) => ramda_1.compose(ramda_1.any(ramda_1.equals('SEGMENT')), pluck('scope'))(hints);
const isPrivateRoute = ({ request: { headers } }) => ramda_1.test(/_v\/graphql\/private\/v*/, headers['x-forwarded-path'] || '');
const isPublicEndpoint = ({ request: { headers } }) => {
    if (headers.origin) {
        return false;
    }
    const host = headers['x-forwarded-host'] || '';
    return ramda_1.test(VTEX_REGEXP, host) || ramda_1.test(GOCOMMERCE_REGEXP, host);
};
exports.cacheControl = (response, ctx) => {
    const { vtex: { production } } = ctx;
    const hints = response && pickCacheControlHints(response);
    const age = hints && minMaxAge(hints);
    const isPrivate = hints && anyPrivate(hints);
    const segment = hints && anySegment(hints);
    return {
        maxAge: (age === 0 || isPublicEndpoint(ctx) || !production) ? 'no-cache, no-store' : `max-age=${age}`,
        scope: (isPrivate || isPrivateRoute(ctx)) ? 'private' : 'public',
        segment,
    };
};
